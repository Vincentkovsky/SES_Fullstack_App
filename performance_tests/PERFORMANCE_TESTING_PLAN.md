# 洪水预测系统性能测试规划方案（精简版）
## Performance Testing Plan - Focused Version

> 专注于REST API性能、吞吐量、并发能力和瓦片生成速度的测试方案

---

## 1. 测试目标

### 1.1 核心指标
1. **REST API响应时间**: P50, P95, P99百分位数
2. **吞吐量**: 每秒处理的请求数 (requests/sec)
3. **并发处理能力**: 系统能同时处理的并发请求数
4. **实时瓦片生成速度**: 从GeoTIFF文件生成单个瓦片的耗时

### 1.2 测试范围
- **主要API端点**:
  - `GET /api/tiles/{simulation_id}/{timestep_id}/{z}/{x}/{y}.png` - 瓦片生成（核心）
  - `GET /api/health` - 健康检查
  - `GET /api/inference/cuda_info` - CUDA信息
  - `GET /api/water-depth` - 水位查询
  - `GET /api/simulations` - 模拟列表
  - `GET /api/simulations/{simulation_id}/timesteps` - 时间步列表

---

## 2. 测试环境

### 2.1 硬件配置
```
CPU: [记录CPU型号和核心数]
内存: [记录总内存大小]
存储: [记录存储类型和速度]
网络: [记录网络带宽]
```

### 2.2 软件配置
```
操作系统: Linux 4.18.0-553.40.1.el8_10.x86_64
Python: 3.10+
FastAPI: 0.110.0
后端服务: 运行在 localhost:3000
```

### 2.3 测试数据准备
- **GeoTIFF文件**: 准备多个不同大小的GeoTIFF文件用于测试
- **模拟场景**: 确保有可用的simulation_id和timestep_id
- **瓦片坐标**: 准备不同缩放级别(z)和坐标(x, y)的测试用例

---

## 3. 测试指标详细说明

### 3.1 REST API响应时间

#### 测试方法
使用Locust进行压力测试，记录每个请求的响应时间，计算百分位数。

#### 指标定义
- **P50 (中位数)**: 50%的请求响应时间低于此值
- **P95**: 95%的请求响应时间低于此值
- **P99**: 99%的请求响应时间低于此值

#### 测试场景
1. **单端点测试**: 单独测试每个API端点
2. **混合负载测试**: 模拟真实使用场景，混合不同端点
3. **不同缩放级别**: 测试不同z级别的瓦片请求（z=13, 14, 15, 16）

#### 预期目标
- 健康检查: P95 < 10ms
- 瓦片请求（缓存命中）: P95 < 50ms
- 瓦片请求（缓存未命中）: P95 < 500ms
- 其他API: P95 < 100ms

### 3.2 吞吐量 (Throughput)

#### 测试方法
逐步增加并发用户数，测量每秒成功处理的请求数，找到最大吞吐量。

#### 指标定义
- **最大吞吐量**: 系统在稳定状态下能处理的最大 requests/sec
- **不同并发级别下的吞吐量**: 1, 5, 10, 20, 50, 100并发用户

#### 测试场景
1. **单端点吞吐量**: 测试单个端点的最大吞吐量
2. **混合端点吞吐量**: 测试混合请求的总吞吐量
3. **瓦片生成吞吐量**: 专门测试瓦片生成端点的吞吐量

#### 预期目标
- 瓦片生成: > 50 requests/sec (缓存命中)
- 瓦片生成: > 10 requests/sec (缓存未命中，实时生成)
- 其他API: > 100 requests/sec

### 3.3 并发处理能力

#### 测试方法
逐步增加并发用户数，观察系统在什么并发级别下开始出现错误或响应时间显著增加。

#### 指标定义
- **最大并发用户数**: 系统能稳定处理的最大并发连接数
- **错误率阈值**: 错误率 < 1% 时的最大并发数
- **响应时间阈值**: P95响应时间 < 1秒时的最大并发数

#### 测试场景
1. **逐步增加并发**: 从1个用户开始，逐步增加到系统极限
2. **长时间并发测试**: 在最大并发下运行5-10分钟，观察稳定性
3. **突发流量测试**: 模拟突发高并发请求

#### 预期目标
- 最大并发用户数: > 50
- 在50并发下错误率: < 1%
- 在50并发下P95响应时间: < 1秒

### 3.4 实时瓦片生成速度

#### 测试方法
专门测试从GeoTIFF文件实时生成瓦片的性能，包括缓存命中和未命中两种情况。

#### 指标定义
- **缓存命中时间**: 从缓存获取瓦片的时间（应 < 10ms）
- **实时生成时间**: 从GeoTIFF生成新瓦片的时间
- **不同缩放级别的时间**: z=13, 14, 15, 16的生成时间
- **不同区域的时间**: 不同坐标区域的生成时间

#### 测试场景
1. **单瓦片生成时间**: 测试单个瓦片的生成耗时
2. **批量瓦片生成**: 测试连续生成多个瓦片的总时间
3. **缓存效果**: 测试缓存命中率对性能的影响
4. **不同GeoTIFF大小**: 测试不同大小的GeoTIFF文件的处理时间

#### 预期目标
- 缓存命中: < 10ms
- 实时生成（z=14）: < 200ms
- 实时生成（z=15）: < 300ms
- 实时生成（z=16）: < 500ms

---

## 4. 测试工具

### 4.1 主要工具
- **Locust**: 用于API压力测试和吞吐量测试
- **Python脚本**: 用于瓦片生成速度的专门测试
- **统计分析**: Python (pandas, numpy) 用于数据分析

### 4.2 数据收集
- 响应时间数据（CSV格式）
- 吞吐量数据
- 错误日志
- 系统资源使用情况（可选）

---

## 5. 测试实施步骤

### 步骤1: 准备测试环境（1天）
- [ ] 确认后端服务正常运行
- [ ] 准备测试数据（GeoTIFF文件、simulation_id等）
- [ ] 安装测试工具（Locust）
- [ ] 验证API端点可访问

### 步骤2: API响应时间测试（2-3天）
- [ ] 创建Locust测试脚本
- [ ] 测试每个API端点
- [ ] 收集响应时间数据
- [ ] 计算P50, P95, P99百分位数
- [ ] 生成响应时间分布图

### 步骤3: 吞吐量测试（2-3天）
- [ ] 设计吞吐量测试场景
- [ ] 逐步增加并发用户数
- [ ] 记录不同并发级别下的吞吐量
- [ ] 找到最大吞吐量点
- [ ] 生成吞吐量曲线图

### 步骤4: 并发处理能力测试（2-3天）
- [ ] 设计并发测试场景
- [ ] 逐步增加并发数直到系统极限
- [ ] 记录错误率和响应时间变化
- [ ] 确定最大稳定并发数
- [ ] 进行长时间稳定性测试

### 步骤5: 瓦片生成速度测试（2-3天）
- [ ] 创建专门的瓦片生成测试脚本
- [ ] 测试缓存命中和未命中两种情况
- [ ] 测试不同缩放级别
- [ ] 测试不同GeoTIFF文件大小
- [ ] 分析缓存效果

### 步骤6: 数据分析和报告（2-3天）
- [ ] 汇总所有测试数据
- [ ] 统计分析
- [ ] 生成可视化图表
- [ ] 撰写测试报告
- [ ] 准备Journal文章所需的数据和图表

---

## 6. 预期测试结果格式

### 6.1 响应时间报告
```
API端点: GET /api/tiles/{simulation_id}/{timestep_id}/{z}/{x}/{y}.png
测试请求数: 10,000
P50: 45ms
P95: 180ms
P99: 450ms
平均响应时间: 65ms
最小响应时间: 8ms
最大响应时间: 1200ms
```

### 6.2 吞吐量报告
```
并发用户数 | 吞吐量 (req/s) | 错误率 (%) | P95响应时间 (ms)
1          | 25            | 0          | 50
5          | 80            | 0          | 120
10         | 120           | 0          | 180
20         | 150           | 0.1        | 250
50         | 140           | 0.5        | 450
100        | 100           | 2.0        | 800
```

### 6.3 瓦片生成速度报告
```
缩放级别 | 缓存命中时间 (ms) | 实时生成时间 (ms) | 生成速度 (tiles/sec)
z=13     | 5                | 120              | 8.3
z=14     | 6                | 180              | 5.6
z=15     | 7                | 280              | 3.6
z=16     | 8                | 450              | 2.2
```

---

## 7. 所需图表

1. **响应时间分布图**: 箱线图或小提琴图
2. **吞吐量曲线**: 并发用户数 vs 吞吐量
3. **响应时间曲线**: 并发用户数 vs P95响应时间
4. **瓦片生成时间对比**: 不同缩放级别和缓存状态的对比
5. **错误率曲线**: 并发用户数 vs 错误率

---

## 8. 风险评估

1. **测试数据不足**: 确保有足够的GeoTIFF文件和测试场景
2. **系统资源限制**: 监控系统资源，避免测试影响系统稳定性
3. **缓存干扰**: 注意缓存对测试结果的影响，需要分别测试缓存命中和未命中

---

**文档版本**: v2.0 (精简版)  
**创建日期**: 2025-01-XX  
**最后更新**: 2025-01-XX
