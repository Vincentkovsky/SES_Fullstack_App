# API性能测试计划
## API Performance Testing Plan

> 专注于REST API性能、吞吐量、并发能力和实时瓦片生成速度

---

## 1. 测试目标

### 1.1 核心指标
1. **REST API响应时间**: P50, P95, P99百分位数
2. **吞吐量**: 每秒处理的请求数 (requests/sec)
3. **并发处理能力**: 系统能同时处理的并发请求数
4. **实时瓦片生成速度**: 从GeoTIFF实时生成单个瓦片的耗时

### 1.2 测试范围
- **主要API端点**:
  - `GET /api/health` - 健康检查
  - `GET /api/tiles/{simulation_id}/{timestep_id}/{z}/{x}/{y}.png` - 实时瓦片生成（核心）
  - `GET /api/water-depth` - 水位深度查询
  - `GET /api/inference/cuda_info` - CUDA信息查询
  - `GET /api/simulations/{simulation_id}/timesteps` - 时间步列表

---

## 2. 测试环境

### 2.1 硬件配置
```
CPU: [记录CPU型号和核心数]
内存: [记录总内存大小]
存储: [记录存储类型和速度]
网络: [记录网络带宽]
```

### 2.2 软件配置
```
操作系统: Linux 4.18.0-553.40.1.el8_10.x86_64
Python: 3.10+
FastAPI: 0.110.0
Uvicorn: [版本号]
```

### 2.3 测试数据准备
- **GeoTIFF文件**: 准备多个不同大小的GeoTIFF文件用于测试
- **测试坐标**: 准备不同缩放级别(z)和坐标(x, y)的测试用例
- **模拟场景**: 使用现有的simulation_id进行测试

---

## 3. 测试指标定义

### 3.1 REST API响应时间

**指标说明**:
- **P50 (中位数)**: 50%的请求响应时间低于此值
- **P95**: 95%的请求响应时间低于此值
- **P99**: 99%的请求响应时间低于此值

**测试方法**:
- 使用Locust或wrk进行压力测试
- 记录每个请求的响应时间
- 计算百分位数

**预期目标**:
- 健康检查: P95 < 10ms
- 瓦片请求（缓存命中）: P95 < 50ms
- 瓦片请求（缓存未命中）: P95 < 500ms
- 水位查询: P95 < 100ms

### 3.2 吞吐量 (Throughput)

**指标说明**:
- **吞吐量**: 系统每秒能处理的请求数 (requests/sec)
- **峰值吞吐量**: 系统能达到的最大吞吐量

**测试方法**:
- 逐步增加并发用户数
- 记录每秒请求数
- 找到吞吐量峰值和稳定值

**测试场景**:
- 单端点测试（仅瓦片API）
- 混合端点测试（多个API端点混合）

**预期目标**:
- 瓦片API: > 100 requests/sec (缓存命中)
- 瓦片API: > 20 requests/sec (缓存未命中，实时生成)
- 混合端点: > 50 requests/sec

### 3.3 并发处理能力

**指标说明**:
- **最大并发数**: 系统能同时处理的请求数
- **并发性能下降点**: 性能开始显著下降的并发数
- **系统稳定性**: 高并发下的错误率

**测试方法**:
- 逐步增加并发用户数（1, 10, 50, 100, 200, 500...）
- 记录响应时间、吞吐量、错误率
- 找到性能拐点

**测试场景**:
- 低并发（1-10用户）
- 中并发（10-100用户）
- 高并发（100-500用户）
- 极限并发（500+用户）

**预期目标**:
- 稳定处理: > 100并发用户
- 可接受性能: > 200并发用户
- 错误率: < 1% (在稳定并发范围内)

### 3.4 实时瓦片生成速度

**指标说明**:
- **单瓦片生成时间**: 从GeoTIFF文件生成单个瓦片的耗时
- **不同缩放级别**: 不同z值的生成时间对比
- **缓存影响**: 缓存命中 vs 缓存未命中的性能差异

**测试方法**:
- 直接调用瓦片生成函数，记录时间
- 测试不同缩放级别 (z=10, 12, 14, 16)
- 测试不同GeoTIFF文件大小
- 测试缓存命中率

**测试场景**:
- 缓存命中（已生成过）
- 缓存未命中（首次生成）
- 不同缩放级别
- 不同GeoTIFF文件大小

**预期目标**:
- 缓存命中: < 10ms
- 缓存未命中 (z=14): < 200ms
- 缓存未命中 (z=16): < 500ms

---

## 4. 测试实施计划

### 4.1 阶段一: 基础性能测试 (3-5天)

#### 任务清单:
1. **设置测试环境**
   - 准备测试脚本
   - 准备测试数据（GeoTIFF文件）
   - 配置测试工具

2. **单端点性能测试**
   - 健康检查API
   - 瓦片API（缓存命中）
   - 瓦片API（缓存未命中）
   - 其他API端点

3. **数据收集**
   - 记录响应时间分布
   - 计算P50/P95/P99
   - 记录吞吐量

**交付物**:
- 基础性能测试报告
- 响应时间分布图
- 吞吐量数据

### 4.2 阶段二: 并发和吞吐量测试 (3-5天)

#### 任务清单:
1. **并发能力测试**
   - 逐步增加并发用户数
   - 记录性能变化
   - 找到性能拐点

2. **吞吐量测试**
   - 单端点峰值吞吐量
   - 混合端点吞吐量
   - 不同负载下的吞吐量

3. **稳定性测试**
   - 长时间运行测试
   - 错误率监控
   - 资源使用监控

**交付物**:
- 并发性能测试报告
- 吞吐量测试报告
- 性能曲线图

### 4.3 阶段三: 瓦片生成性能深入分析 (2-3天)

#### 任务清单:
1. **瓦片生成速度测试**
   - 不同缩放级别的生成时间
   - 不同文件大小的影响
   - 缓存效果分析

2. **性能优化分析**
   - 识别性能瓶颈
   - 优化建议

**交付物**:
- 瓦片生成性能报告
- 优化建议文档

### 4.4 阶段四: 数据汇总和报告 (2-3天)

#### 任务清单:
1. **数据汇总**
   - 整理所有测试数据
   - 统计分析
   - 生成可视化图表

2. **报告撰写**
   - 测试结果总结
   - 关键发现
   - Journal文章所需的数据和图表

**交付物**:
- 完整的性能测试报告
- 数据可视化图表
- Journal文章数据

---

## 5. 测试工具

### 5.1 推荐工具
- **Locust**: Python编写的负载测试工具，适合API测试
- **wrk**: 高性能HTTP基准测试工具
- **Apache Bench (ab)**: 简单快速的HTTP基准测试工具
- **自定义Python脚本**: 用于精确控制测试场景

### 5.2 监控工具
- **系统监控**: `htop`, `iostat`, `vmstat`
- **网络监控**: `iftop`, `netstat`
- **应用监控**: FastAPI内置日志，自定义性能日志

---

## 6. 测试脚本结构

### 6.1 Locust测试脚本
```python
# locustfile.py
from locust import HttpUser, task, between
import random

class APIUser(HttpUser):
    wait_time = between(1, 3)
    
    def on_start(self):
        # 初始化测试数据
        self.simulation_id = "test_simulation"
        self.timestep_id = "waterdepth_20221024_1200"
        self.z_levels = [10, 12, 14, 16]
    
    @task(3)
    def get_tile(self):
        z = random.choice(self.z_levels)
        x = random.randint(0, 2**z - 1)
        y = random.randint(0, 2**z - 1)
        self.client.get(
            f"/api/tiles/{self.simulation_id}/{self.timestep_id}/{z}/{x}/{y}.png"
        )
    
    @task(1)
    def get_health(self):
        self.client.get("/api/health")
```

### 6.2 自定义性能测试脚本
```python
# performance_test.py
import asyncio
import aiohttp
import time
import statistics
from typing import List

async def test_tile_generation_speed():
    """测试实时瓦片生成速度"""
    # 实现单瓦片生成时间测试
    pass

async def test_concurrent_requests():
    """测试并发请求处理能力"""
    # 实现并发测试
    pass
```

---

## 7. 数据收集和分析

### 7.1 收集的数据
- **响应时间**: 每个请求的响应时间（ms）
- **吞吐量**: 每秒请求数
- **错误率**: 4xx/5xx错误比例
- **并发数**: 同时处理的请求数
- **系统资源**: CPU、内存、网络使用率

### 7.2 分析方法
- **统计分析**: 计算平均值、中位数、百分位数
- **可视化**: 生成响应时间分布图、吞吐量曲线图
- **对比分析**: 不同配置下的性能对比

### 7.3 报告格式
- **表格**: 关键指标汇总表
- **图表**: 
  - 响应时间分布（箱线图）
  - 吞吐量曲线
  - 并发性能曲线
  - 瓦片生成时间对比

---

## 8. 预期结果

### 8.1 性能基准
基于系统特性，预期达到以下性能指标:

**响应时间**:
- 健康检查: P95 < 10ms
- 瓦片（缓存）: P95 < 50ms
- 瓦片（实时生成）: P95 < 500ms
- 水位查询: P95 < 100ms

**吞吐量**:
- 瓦片API（缓存）: > 100 req/s
- 瓦片API（实时）: > 20 req/s
- 混合端点: > 50 req/s

**并发能力**:
- 稳定处理: > 100并发
- 可接受性能: > 200并发
- 错误率: < 1%

**瓦片生成速度**:
- 缓存命中: < 10ms
- 实时生成 (z=14): < 200ms
- 实时生成 (z=16): < 500ms

---

## 9. 风险评估

### 9.1 潜在风险
1. **测试数据不足**: 可能无法覆盖所有场景
   - **缓解**: 准备多种不同大小的GeoTIFF文件

2. **测试环境差异**: 可能影响结果可重复性
   - **缓解**: 详细记录环境配置

3. **系统资源限制**: 可能无法测试极限情况
   - **缓解**: 使用压力测试工具模拟高负载

### 9.2 数据可靠性
- 每个测试场景至少运行3次，取平均值
- 记录异常值和离群点
- 进行统计分析，计算置信区间

---

## 10. 下一步行动

### 立即开始的任务:
1. ✅ 审查和确认测试计划
2. ⬜ 准备测试数据和环境
3. ⬜ 创建测试脚本
4. ⬜ 开始第一阶段测试

---

**文档版本**: v1.0  
**创建日期**: 2025-01-XX  
**最后更新**: 2025-01-XX
