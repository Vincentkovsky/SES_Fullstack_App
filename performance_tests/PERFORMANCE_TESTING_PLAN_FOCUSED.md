# 洪水预测系统性能测试规划（聚焦版）
## Focused Performance Testing Plan for Flood Prediction System

> 专注于4个关键性能指标的测试方案

---

## 1. 测试目标

### 1.1 核心指标
1. **REST API响应时间（P50/P95/P99）**
   - 测量API端点的响应时间分布
   - 重点关注瓦片生成端点

2. **吞吐量（requests/sec）**
   - 系统每秒能处理的请求数
   - 不同负载下的吞吐量表现

3. **并发处理能力**
   - 不同并发级别下的性能表现
   - 识别性能瓶颈和最优并发数

4. **实时从GeoTIFF生成瓦片的速度**
   - 瓦片生成的端到端时间
   - 缓存命中率的影响
   - 不同缩放级别和坐标的性能差异

---

## 2. 测试端点

### 2.1 主要测试端点

#### `/api/tiles/{simulation_id}/{timestep_id}/{z}/{x}/{y}.png`
- **功能**：从GeoTIFF文件实时生成地图瓦片
- **测试重点**：这是最核心的性能测试端点
- **参数变化**：
  - 不同缩放级别（z=13, 14, 15, 16）
  - 不同瓦片坐标（x, y）
  - 不同模拟和时间步

#### `/api/health`
- **功能**：健康检查
- **用途**：作为基准测试，验证基础API性能

#### `/api/simulations`
- **功能**：获取模拟列表
- **用途**：测试简单查询端点的性能

### 2.2 端点特性

**瓦片生成端点特点**：
- 使用LRU缓存（最大5000个瓦片）
- 使用进程池处理（CPU核心数×2，最大64个进程）
- 涉及GeoTIFF文件读取、坐标转换、重采样、颜色映射、PNG编码
- 缓存命中时响应极快（<10ms），未命中时需要完整处理流程

---

## 3. 测试场景设计

### 3.1 场景1：响应时间分布测试

**目标**：测量P50/P95/P99响应时间

**测试配置**：
- 请求数：1000
- 并发数：10（避免过载影响测量）
- 端点：瓦片生成端点
- 测试多个不同的瓦片坐标

**预期输出**：
- P50响应时间
- P95响应时间
- P99响应时间
- 响应时间分布直方图

### 3.2 场景2：吞吐量测试

**目标**：测量系统最大吞吐量

**测试配置**：
- 并发数：逐步增加（1, 5, 10, 20, 50, 100）
- 每个并发级别：足够的请求数（确保测试持续至少30秒）
- 端点：瓦片生成端点

**预期输出**：
- 不同并发级别下的吞吐量（requests/sec）
- 吞吐量 vs 并发数曲线
- 识别吞吐量峰值和下降点

### 3.3 场景3：并发处理能力测试

**目标**：评估系统在不同并发负载下的表现

**测试配置**：
- 并发级别：1, 5, 10, 20, 50, 100, 200
- 每个级别：固定请求数（如1000）
- 测量指标：
  - 响应时间（P50/P95/P99）
  - 吞吐量
  - 成功率
  - 错误率

**预期输出**：
- 并发数 vs 响应时间曲线
- 并发数 vs 吞吐量曲线
- 系统最优并发数
- 性能下降点识别

### 3.4 场景4：瓦片生成速度专项测试

**目标**：详细分析瓦片生成的性能

**测试配置**：

#### 4.1 缓存命中 vs 未命中
- 测试相同瓦片的重复请求（缓存命中）
- 测试不同瓦片的请求（缓存未命中）
- 对比两种情况的性能差异

#### 4.2 不同缩放级别
- 测试z=13, 14, 15, 16的瓦片生成速度
- 分析缩放级别对性能的影响

#### 4.3 不同区域
- 测试不同地理位置的瓦片（不同的x, y坐标）
- 分析数据密度对性能的影响

**预期输出**：
- 缓存命中率
- 缓存命中时的平均响应时间
- 缓存未命中时的平均响应时间
- 不同缩放级别的性能对比
- 瓦片生成各阶段的时间分解（如果可能）

---

## 4. 测试工具

### 4.1 自定义测试脚本

使用提供的 `api_performance_test.py` 脚本：

**特点**：
- 基于asyncio的异步HTTP客户端
- 支持高并发测试
- 自动计算百分位数
- 生成详细的JSON报告

**使用方法**：
```bash
# 安装依赖
pip install -r requirements.txt

# 运行测试
python api_performance_test.py --url http://localhost:3000
```

### 4.2 可选工具

如果需要更高级的功能，可以考虑：

- **Locust**：分布式负载测试
- **Apache Bench (ab)**：简单快速的基准测试
- **wrk**：高性能HTTP基准测试工具

---

## 5. 数据收集和分析

### 5.1 收集的指标

对于每个测试场景，收集：

1. **响应时间**：
   - 最小值、最大值、平均值、中位数
   - P50, P95, P99百分位数
   - 标准差

2. **吞吐量**：
   - 总请求数 / 总时间
   - 每秒成功请求数

3. **成功率**：
   - 成功请求数 / 总请求数
   - 错误类型和数量

4. **内容大小**（瓦片测试）：
   - 平均PNG文件大小
   - 传输的数据总量

### 5.2 分析维度

1. **时间维度**：
   - 响应时间分布
   - 不同时间段的性能变化

2. **并发维度**：
   - 并发数对性能的影响
   - 最优并发数识别

3. **缓存维度**：
   - 缓存命中率
   - 缓存对性能的提升

4. **空间维度**：
   - 不同缩放级别的性能
   - 不同区域的性能差异

---

## 6. 预期结果和基准

### 6.1 性能目标

基于系统特性，预期达到：

**响应时间**：
- 健康检查：< 10ms (P95)
- 模拟列表：< 50ms (P95)
- 瓦片生成（缓存命中）：< 10ms (P95)
- 瓦片生成（缓存未命中）：< 500ms (P95)

**吞吐量**：
- 健康检查：> 1000 requests/sec
- 瓦片生成（混合负载）：> 50 requests/sec

**并发能力**：
- 支持至少50个并发请求
- 在100并发时性能下降不超过50%

### 6.2 关键发现点

1. **缓存效果**：
   - 缓存命中率应该随着重复请求增加
   - 缓存命中时的性能提升倍数

2. **并发瓶颈**：
   - 识别性能开始下降的并发数
   - 分析瓶颈原因（CPU、内存、I/O）

3. **缩放级别影响**：
   - 不同缩放级别的性能差异
   - 数据密度对处理时间的影响

---

## 7. 测试执行计划

### 7.1 准备阶段（1天）

1. **环境准备**：
   - 确保后端服务正常运行
   - 准备测试数据（确保有可用的模拟和时间步）
   - 安装测试工具和依赖

2. **基线测试**：
   - 运行简单的健康检查测试
   - 验证测试工具正常工作

### 7.2 执行阶段（2-3天）

1. **第一天**：响应时间分布测试
   - 执行场景1和场景4.1（缓存测试）
   - 收集基础性能数据

2. **第二天**：吞吐量和并发测试
   - 执行场景2和场景3
   - 测试不同并发级别

3. **第三天**：专项测试和补充
   - 执行场景4.2和4.3（缩放级别和区域测试）
   - 补充遗漏的测试场景
   - 重复关键测试以验证结果

### 7.3 分析阶段（1-2天）

1. **数据整理**：
   - 汇总所有测试结果
   - 计算统计指标

2. **可视化**：
   - 生成性能对比图表
   - 创建响应时间分布图
   - 绘制吞吐量曲线

3. **报告撰写**：
   - 总结关键发现
   - 准备Journal文章所需的数据和图表

---

## 8. 报告格式（Journal Article）

### 8.1 性能评估章节结构

1. **实验设置**
   - 测试环境配置
   - 测试工具和方法
   - 测试数据集描述

2. **实验结果**
   - REST API响应时间（P50/P95/P99）
   - 吞吐量测试结果
   - 并发处理能力分析
   - 瓦片生成性能详细分析

3. **结果讨论**
   - 性能瓶颈分析
   - 缓存效果评估
   - 系统优化建议

### 8.2 所需图表

1. **响应时间分布图**：
   - 箱线图或小提琴图
   - 显示P50/P95/P99

2. **吞吐量曲线**：
   - 并发数 vs 吞吐量
   - 识别峰值和下降点

3. **性能对比表**：
   - 不同并发级别下的关键指标
   - 缓存命中 vs 未命中对比

4. **瓦片生成性能分析**：
   - 不同缩放级别的性能对比
   - 缓存命中率统计

---

## 9. 使用测试脚本

### 9.1 快速开始

```bash
# 1. 进入测试目录
cd performance_tests

# 2. 安装依赖
pip install -r requirements.txt

# 3. 运行测试（自动查找可用数据）
python api_performance_test.py

# 4. 查看结果
cat performance_test_results.json
```

### 9.2 自定义测试

```bash
# 指定特定的模拟和时间步
python api_performance_test.py \
    --simulation inference_1751611329_20221008 \
    --timestep waterdepth_20221024_1200 \
    --z 14 \
    --x 931 \
    --y 619 \
    --output my_test_results.json
```

### 9.3 结果分析

测试脚本会自动：
- 计算所有百分位数
- 生成统计摘要
- 保存详细的JSON报告

可以使用Python脚本进一步分析JSON报告，生成可视化图表。

---

## 10. 注意事项

1. **测试环境一致性**：
   - 确保测试期间系统负载稳定
   - 避免其他进程干扰

2. **数据准备**：
   - 确保有足够的测试数据
   - 不同缩放级别和区域的瓦片

3. **缓存影响**：
   - 首次测试会建立缓存
   - 考虑测试"冷启动"和"热缓存"两种情况

4. **系统资源**：
   - 高并发测试会占用大量资源
   - 监控系统资源使用情况

---

**文档版本**: v1.0  
**创建日期**: 2025-01-XX  
**维护者**: [您的名字]
