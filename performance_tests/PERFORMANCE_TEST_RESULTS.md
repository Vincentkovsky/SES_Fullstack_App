# API性能测试完整报告

## 测试概述

**测试时间**: 2026-01-16  
**API地址**: http://localhost:3000  
**测试端点**: `/api/tiles/{simulation_id}/{timestep_id}/{z}/{x}/{y}.png`  
**模拟ID**: `inference_1751611329_20221008`  
**时间步**: `waterdepth_20221008_000000`  
**测试缩放级别**: z=14

---

## 1. REST API响应时间（P50/P95/P99）

### 1.1 瓦片生成端点 - 缓存未命中（实时生成）

**测试场景**: 首次请求不同瓦片坐标，触发实时从GeoTIFF生成瓦片

| 指标 | 数值 |
|------|------|
| 测试请求数 | 10（不同瓦片坐标） |
| 平均响应时间 | 22ms |
| P50 (中位数) | 16ms |
| P95 | 88ms |
| P99 | 88ms |
| 最小响应时间 | 15ms |
| 最大响应时间 | 88ms |

**结论**: 首次生成瓦片时，大部分请求在16ms左右完成，但有个别请求达到88ms（可能是首次加载或系统预热）。

### 1.2 瓦片生成端点 - 缓存命中

**测试场景**: 重复请求相同瓦片坐标，从缓存中获取

| 指标 | 数值 |
|------|------|
| 测试请求数 | 50（相同瓦片坐标） |
| 平均响应时间 | 7ms |
| P50 (中位数) | 7ms |
| P95 | 8ms |
| P99 | 11ms |
| 最小响应时间 | 7ms |
| 最大响应时间 | 11ms |

**结论**: 缓存命中后，响应时间显著降低，性能稳定，P99都在11ms以内。

### 1.3 缓存效果分析

| 指标 | 缓存未命中 | 缓存命中 | 提升 |
|------|-----------|---------|------|
| 平均响应时间 | 22ms | 7ms | **3.14x** |
| P50 | 16ms | 7ms | **2.29x** |
| P95 | 88ms | 8ms | **11x** |
| P99 | 88ms | 11ms | **8x** |

**结论**: 缓存机制有效提升了性能，响应时间降低了约68%，P95性能提升11倍。

---

## 2. 吞吐量测试（requests/sec）

**测试方法**: 在不同并发级别下，持续运行30秒，测量系统吞吐量

| 并发数 | 持续时间(秒) | 总请求数 | 成功数 | 失败数 | 吞吐量(req/s) | 平均响应时间(ms) | P50(ms) | P95(ms) | P99(ms) |
|--------|-------------|---------|--------|--------|--------------|-----------------|---------|---------|---------|
| 1 | 30 | 1,395 | 1,395 | 0 | 46 | 7 | 8 | 9 | 10 |
| 5 | 30 | 6,452 | 6,452 | 0 | 215 | 9 | 9 | 16 | 28 |
| 10 | 30 | 11,064 | 11,064 | 0 | 368 | 12 | 12 | 17 | 23 |
| 20 | 30 | 10,944 | 10,944 | 0 | 364 | 40 | 38 | 46 | 94 |
| 50 | 30 | 11,324 | 11,324 | 0 | **377** | 117 | 116 | 129 | 160 |

### 吞吐量分析

- **最大吞吐量**: **377 requests/sec**（并发数=50）
- **最佳并发区间**: 10-50并发，吞吐量稳定在360-377 req/s
- **性能趋势**:
  - 并发数1-10: 吞吐量线性增长（46 → 368 req/s）
  - 并发数10-50: 吞吐量趋于稳定（368 → 377 req/s）
  - 并发数20时出现轻微下降（364 req/s），可能是系统资源竞争导致

### 响应时间随并发变化

- **低并发（1-10）**: 响应时间稳定在7-12ms，P99在10-28ms
- **中并发（20）**: 响应时间增加到40ms，P99达到94ms
- **高并发（50）**: 响应时间增加到117ms，P99达到160ms

**结论**: 系统在50并发时达到最大吞吐量377 req/s，但响应时间相应增加。建议根据业务需求在吞吐量和响应时间之间平衡。

---

## 3. 并发处理能力测试

**测试方法**: 在不同并发级别下，完成固定数量的请求（每个并发级别请求数=并发数×100），测量完成时间和错误率

| 并发数 | 总请求数 | 成功数 | 失败数 | 总时间(秒) | 吞吐量(req/s) | 平均响应时间(ms) | P50(ms) | P95(ms) | P99(ms) | 错误率(%) |
|--------|---------|--------|--------|-----------|--------------|-----------------|---------|---------|---------|----------|
| 1 | 100 | 100 | 0 | 1 | 100 | 8 | 8 | 11 | 22 | 0 |
| 5 | 500 | 500 | 0 | 1 | 500 | 11 | 11 | 14 | 16 | 0 |
| 10 | 1,000 | 1,000 | 0 | 2 | 500 | 23 | 24 | 26 | 44 | 0 |
| 20 | 2,000 | 2,000 | 0 | 5 | 400 | 50 | 50 | 53 | 120 | 0 |
| 50 | 5,000 | 5,000 | 0 | 13 | 384 | 132 | 130 | 154 | 224 | 0 |
| 100 | 10,000 | 10,000 | 0 | 26 | 384 | 264 | 260 | 292 | 394 | 0 |

### 并发能力分析

- **最大并发数（错误率<1%）**: **100并发**，所有请求成功，错误率0%
- **最大并发数（错误率<5%）**: **100并发**，所有请求成功，错误率0%
- **吞吐量峰值**: 在并发数5时达到**500 req/s**，之后稳定在384-400 req/s
- **性能瓶颈**: 
  - 并发数1-5: 吞吐量快速增长（100 → 500 req/s）
  - 并发数5-10: 吞吐量保持稳定（500 req/s）
  - 并发数10-100: 吞吐量略有下降并稳定（400-384 req/s）

### 响应时间随并发变化

- **低并发（1-5）**: 响应时间8-11ms，P99在16-22ms
- **中并发（10-20）**: 响应时间23-50ms，P99在44-120ms
- **高并发（50-100）**: 响应时间132-264ms，P99在224-394ms

**结论**: 系统在100并发下仍能保持0%错误率，但响应时间显著增加。建议生产环境根据实际需求选择合适的并发级别。

---

## 4. 实时从GeoTIFF生成瓦片的速度

### 4.1 缓存未命中（实时生成）

**测试场景**: 首次请求，需要从GeoTIFF文件实时生成瓦片

| 指标 | 数值 |
|------|------|
| 平均生成时间 | 22ms |
| P50 | 16ms |
| P95 | 88ms |
| P99 | 88ms |

**性能评估**: ✅ **优秀** - 实时生成瓦片平均仅需22ms，P95为88ms，远低于500ms的目标阈值。

### 4.2 缓存命中（从缓存获取）

**测试场景**: 重复请求，从内存缓存中获取已生成的瓦片

| 指标 | 数值 |
|------|------|
| 平均获取时间 | 7ms |
| P50 | 7ms |
| P95 | 8ms |
| P99 | 11ms |

**性能评估**: ✅ **优秀** - 缓存命中后响应时间降低到7ms，性能提升3.14倍。

### 4.3 缓存加速效果

| 场景 | 平均时间 | P95 | 加速比 |
|------|---------|-----|--------|
| 实时生成 | 22ms | 88ms | 1x |
| 缓存命中 | 7ms | 8ms | **3.14x** |

**结论**: 缓存机制显著提升了瓦片获取速度，实时生成性能也达到了优秀水平。

---

## 5. 综合性能评估

### 5.1 响应时间评估

| 测试场景 | P50 | P95 | P99 | 评估 |
|---------|-----|-----|-----|------|
| 瓦片生成（缓存命中） | 7ms | 8ms | 11ms | ✅ 优秀 |
| 瓦片生成（缓存未命中） | 16ms | 88ms | 88ms | ✅ 良好 |
| 低并发吞吐量测试（1-10并发） | 8-12ms | 9-17ms | 10-28ms | ✅ 优秀 |
| 中并发吞吐量测试（20并发） | 38ms | 46ms | 94ms | ✅ 良好 |
| 高并发吞吐量测试（50并发） | 116ms | 129ms | 160ms | ✅ 可接受 |

### 5.2 吞吐量评估

| 测试场景 | 吞吐量 | 评估 |
|---------|--------|------|
| 持续负载测试（30秒） | 377 req/s | ✅ 优秀 |
| 并发能力测试（固定请求数） | 500 req/s（峰值） | ✅ 优秀 |

### 5.3 并发能力评估

| 指标 | 结果 | 评估 |
|------|------|------|
| 最大并发数（错误率<1%） | 100 | ✅ 优秀 |
| 最大并发数（错误率<5%） | 100 | ✅ 优秀 |
| 100并发下的错误率 | 0% | ✅ 优秀 |

---

## 6. 关键发现

1. **缓存效果显著**: 缓存命中后响应时间从22ms降低到7ms，提升约3倍，P95性能提升11倍。

2. **实时生成性能优秀**: 即使缓存未命中，实时生成瓦片的平均响应时间也只有22ms，P95为88ms，远低于500ms的目标。

3. **吞吐量表现优秀**: 系统在50并发时达到最大吞吐量377 req/s，在并发能力测试中峰值达到500 req/s。

4. **并发处理能力强**: 系统在100并发下仍能保持0%错误率，所有请求成功完成。

5. **响应时间稳定**: 缓存命中的瓦片请求响应时间非常稳定，P99都在11ms以内。

6. **性能瓶颈**: 在高并发（50-100）下，响应时间显著增加（132-264ms），但系统仍能稳定处理所有请求。

---

## 7. 性能目标对比

| 指标 | 目标 | 实际结果 | 状态 |
|------|------|----------|------|
| 瓦片生成（缓存）P95 | < 50ms | 8ms | ✅ 超标 |
| 瓦片生成（实时）P95 | < 500ms | 88ms | ✅ 超标 |
| 吞吐量 | > 100 req/s | 377 req/s | ✅ 超标 |
| 并发能力（错误率<1%） | > 50 | 100 | ✅ 超标 |
| 并发能力（错误率<5%） | > 50 | 100 | ✅ 超标 |

**结论**: 所有性能指标都达到了预期目标，部分指标远超预期。

---

## 8. 建议

### 8.1 缓存策略优化

当前缓存效果良好，可以考虑：
- 增加缓存大小（当前最大5000个瓦片）
- 优化缓存淘汰策略（LRU、LFU等）
- 考虑分布式缓存（Redis）以支持多实例部署

### 8.2 性能监控

建议在生产环境中持续监控：
- P95和P99响应时间
- 缓存命中率
- 系统资源使用情况（CPU、内存、I/O）
- 错误率和失败请求数
- 吞吐量趋势

### 8.3 负载均衡

根据测试结果，建议：
- 单实例可处理100并发，吞吐量约377-500 req/s
- 如需更高吞吐量，可考虑水平扩展（多实例+负载均衡）
- 建议每个实例处理50-100并发，以获得最佳性能平衡

### 8.4 进一步优化

- **异步处理**: 对于高并发场景，可考虑异步生成瓦片并返回任务ID
- **预生成**: 对于热门区域和时间步，可预先生成瓦片
- **CDN集成**: 将生成的瓦片缓存到CDN，进一步降低响应时间

---

## 9. 测试方法说明

### 9.1 响应时间测试

- **工具**: `curl` + `bash`脚本
- **方法**: 发送HTTP请求，测量响应时间，计算P50/P95/P99
- **测试端点**: `/api/tiles/{simulation_id}/{timestep_id}/{z}/{x}/{y}.png`

### 9.2 吞吐量测试

- **工具**: `curl` + `bash`脚本（`throughput_concurrent_test.sh`）
- **方法**: 在不同并发级别下持续运行30秒，统计总请求数和成功数
- **计算公式**: 吞吐量 = 总请求数 / 持续时间

### 9.3 并发能力测试

- **工具**: `curl` + `bash`脚本（`throughput_concurrent_test.sh`）
- **方法**: 在不同并发级别下完成固定数量的请求，测量完成时间和错误率
- **计算公式**: 
  - 吞吐量 = 总请求数 / 总时间
  - 错误率 = 失败数 / 总请求数 × 100%

### 9.4 瓦片生成速度测试

- **方法**: 
  - 缓存未命中：请求不同瓦片坐标，触发实时生成
  - 缓存命中：重复请求相同瓦片坐标，从缓存获取
- **指标**: 响应时间（包含生成/获取时间）

---

## 10. 测试环境

- **API地址**: http://localhost:3000
- **测试时间**: 2026-01-16
- **测试工具**: 
  - `curl` (HTTP客户端)
  - `bash` (脚本执行)
- **测试数据**: 
  - 模拟ID: `inference_1751611329_20221008`
  - 时间步: `waterdepth_20221008_000000`
  - 缩放级别: z=14
  - 瓦片坐标: 931/619（缓存命中测试），多个不同坐标（缓存未命中测试）

---

## 11. 附录

### 11.1 测试脚本

- `simple_performance_test.sh`: 响应时间测试
- `throughput_concurrent_test.sh`: 吞吐量和并发能力测试

### 11.2 测试结果文件

- `test_results/performance_test_20260116_180620.txt`: 响应时间测试原始结果
- `test_results/throughput_results.csv`: 吞吐量测试CSV数据
- `test_results/concurrent_capacity_results.csv`: 并发能力测试CSV数据
- `test_results/throughput_concurrent_summary_20260116_181440.txt`: 吞吐量和并发测试摘要

---

**报告生成时间**: 2026-01-16  
**报告版本**: 1.0  
**测试完成**: ✅ 所有测试已完成
