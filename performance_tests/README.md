# API性能测试工具

## 测试指标

本测试工具专注于测试以下4个关键性能指标：

1. **REST API响应时间（P50/P95/P99）** - 百分位数响应时间
2. **吞吐量（requests/sec）** - 每秒处理的请求数
3. **并发处理能力** - 不同并发级别下的性能表现
4. **实时从GeoTIFF生成瓦片的速度** - 瓦片生成端点的性能

## 安装依赖

```bash
pip install aiohttp numpy
```

## 使用方法

### 基本用法

```bash
# 使用默认配置（自动查找可用的模拟数据）
python api_performance_test.py

# 指定API地址
python api_performance_test.py --url http://localhost:3000

# 手动指定模拟和时间步
python api_performance_test.py \
    --simulation inference_1751611329_20221008 \
    --timestep waterdepth_20221024_1200 \
    --z 14 \
    --x 931 \
    --y 619
```

### 参数说明

- `--url`: API基础URL（默认: http://localhost:3000）
- `--simulation`: 模拟ID（可选，如果不提供会自动查找）
- `--timestep`: 时间步ID（可选，如果不提供会自动查找）
- `--z`: 缩放级别（默认: 14）
- `--x`: 瓦片X坐标（默认: 931）
- `--y`: 瓦片Y坐标（默认: 619）
- `--output`: 输出JSON报告文件路径（默认: performance_test_results.json）

## 测试内容

测试脚本会执行以下测试：

1. **健康检查端点测试**
   - 100个请求，并发数10
   - 测试基础API响应性能

2. **模拟列表端点测试**
   - 50个请求，并发数10
   - 测试列表查询性能

3. **瓦片生成端点测试**（主要测试）
   - 多个并发级别：1, 5, 10, 20, 50, 100
   - 每个级别测试不同数量的请求
   - 测试从GeoTIFF实时生成瓦片的性能

## 输出结果

测试完成后会：

1. **控制台输出**：实时显示测试进度和结果摘要
2. **JSON报告文件**：包含详细的测试数据和统计信息

### 报告内容

- **总体统计**：
  - 平均吞吐量（requests/sec）
  - 平均响应时间（P50/P95/P99）
  - 最大并发数

- **详细结果**：
  - 每个测试的详细性能指标
  - 成功率
  - 响应时间分布
  - 内容大小（瓦片测试）

## 结果解读

### 响应时间（P50/P95/P99）

- **P50（中位数）**：50%的请求在此时间内完成
- **P95**：95%的请求在此时间内完成
- **P99**：99%的请求在此时间内完成

### 吞吐量

- 表示系统每秒能处理的请求数
- 更高的吞吐量表示系统处理能力更强

### 并发处理能力

- 测试不同并发级别下的性能表现
- 可以识别系统的性能瓶颈和最优并发数

### 瓦片生成速度

- 专门测试从GeoTIFF文件实时生成瓦片的性能
- 包括缓存命中率和未命中时的生成速度

## 示例输出

```
================================================================================
性能测试报告
================================================================================
测试时间: 2025-01-XX 10:30:00
API地址: http://localhost:3000

总体统计:

  TILE 端点:
    测试次数: 6
    平均吞吐量: 45.32 requests/sec
    平均响应时间 (P50): 125.50 ms
    平均响应时间 (P95): 285.30 ms
    平均响应时间 (P99): 450.20 ms
    最大并发数: 100
```

## 注意事项

1. **确保后端服务运行**：测试前确保FastAPI后端服务正在运行
2. **数据准备**：确保有可用的模拟数据用于测试
3. **系统资源**：高并发测试可能会占用大量系统资源
4. **网络延迟**：如果API在远程服务器，网络延迟会影响结果

## 用于Journal文章

测试结果可以用于：

1. **性能对比表**：不同并发级别下的性能指标
2. **响应时间分布图**：P50/P95/P99的箱线图或小提琴图
3. **吞吐量曲线**：并发数 vs 吞吐量的关系图
4. **瓦片生成性能分析**：缓存命中率、生成速度等

## 后续分析

可以使用Python脚本分析JSON报告，生成可视化图表：

```python
import json
import matplotlib.pyplot as plt

# 读取报告
with open('performance_test_results.json') as f:
    report = json.load(f)

# 提取数据并绘制图表
# ...
```
